# stance.models.policy

Policy data model for Mantissa Stance.

This module defines the Policy class representing security policy definitions
loaded from YAML files, and PolicyCollection for managing groups of policies.

## Contents

### Classes

- [CheckType](#checktype)
- [ComplianceMapping](#compliancemapping)
- [Remediation](#remediation)
- [Check](#check)
- [Policy](#policy)
- [PolicyCollection](#policycollection)

### Functions


## CheckType

**Inherits from:** Enum

Type of policy check.

## ComplianceMapping

**Tags:** dataclass

Maps a policy to a compliance framework control.

Attributes:
    framework: Framework identifier (e.g., "cis-aws-foundations")
    version: Framework version (e.g., "1.5.0")
    control: Control identifier (e.g., "1.5")

### Attributes

| Name | Type | Default |
|------|------|---------|
| `framework` | `str` | - |
| `version` | `str` | - |
| `control` | `str` | - |

### Methods

#### `to_dict(self) -> dict[(str, str)]`

Convert to dictionary.

**Returns:**

`dict[(str, str)]`

### Class Methods

#### `from_dict(cls, data: dict[(str, Any)]) -> ComplianceMapping`

**Decorators:** @classmethod

Create from dictionary.

**Parameters:**

- `data` (`dict[(str, Any)]`)

**Returns:**

`ComplianceMapping`

## Remediation

**Tags:** dataclass

Remediation guidance for a policy finding.

Attributes:
    guidance: Human-readable remediation steps
    automation_supported: Whether automated remediation is available
        (always False in Stance - read-only by design)

### Attributes

| Name | Type | Default |
|------|------|---------|
| `guidance` | `str` | `` |
| `automation_supported` | `bool` | `False` |

### Methods

#### `to_dict(self) -> dict[(str, Any)]`

Convert to dictionary.

**Returns:**

`dict[(str, Any)]`

### Class Methods

#### `from_dict(cls, data: dict[(str, Any)]) -> Remediation`

**Decorators:** @classmethod

Create from dictionary.

**Parameters:**

- `data` (`dict[(str, Any)]`)

**Returns:**

`Remediation`

## Check

**Tags:** dataclass

Evaluation logic for a policy.

Attributes:
    check_type: Type of check (expression or SQL)
    expression: Expression string for expression checks
    query: SQL query for SQL checks

### Attributes

| Name | Type | Default |
|------|------|---------|
| `check_type` | `CheckType` | - |
| `expression` | `str | None` | - |
| `query` | `str | None` | - |

### Methods

#### `to_dict(self) -> dict[(str, Any)]`

Convert to dictionary.

**Returns:**

`dict[(str, Any)]`

### Class Methods

#### `from_dict(cls, data: dict[(str, Any)]) -> Check`

**Decorators:** @classmethod

Create from dictionary.

**Parameters:**

- `data` (`dict[(str, Any)]`)

**Returns:**

`Check`

## Policy

**Tags:** dataclass

Security policy definition.

Policies define security checks to evaluate against cloud resources.
They are loaded from YAML files and evaluated by the policy engine.

Attributes:
    id: Unique policy identifier (e.g., "aws-iam-001")
    name: Human-readable policy name
    description: Detailed explanation of what the policy checks
    enabled: Whether the policy is enabled for evaluation
    severity: Severity level of findings generated by this policy
    resource_type: AWS resource type this policy applies to
    check: The evaluation logic (expression or SQL)
    compliance: List of compliance framework mappings
    remediation: Remediation guidance
    tags: List of tags for categorization
    references: List of reference URLs

### Attributes

| Name | Type | Default |
|------|------|---------|
| `id` | `str` | - |
| `name` | `str` | - |
| `description` | `str` | - |
| `severity` | `Severity` | - |
| `resource_type` | `str` | - |
| `check` | `Check` | - |
| `enabled` | `bool` | `True` |
| `compliance` | `list[ComplianceMapping]` | `field(...)` |
| `remediation` | `Remediation` | `field(...)` |
| `tags` | `list[str]` | `field(...)` |
| `references` | `list[str]` | `field(...)` |

### Methods

#### `is_enabled(self) -> bool`

Check if this policy is enabled.

**Returns:**

`bool` - True if enabled

#### `get_compliance_controls(self) -> list[str]`

Get formatted list of compliance controls.

**Returns:**

`list[str]` - List of formatted control strings

#### `matches_resource_type(self, resource_type: str) -> bool`

Check if this policy applies to a resource type.

**Parameters:**

- `resource_type` (`str`) - Resource type to check

**Returns:**

`bool` - True if policy applies to this resource type

#### `to_dict(self) -> dict[(str, Any)]`

Convert policy to dictionary representation.

**Returns:**

`dict[(str, Any)]` - Dictionary with all policy fields

### Class Methods

#### `from_dict(cls, data: dict[(str, Any)]) -> Policy`

**Decorators:** @classmethod

Create a Policy from a dictionary.

**Parameters:**

- `data` (`dict[(str, Any)]`) - Dictionary with policy fields

**Returns:**

`Policy` - New Policy instance

#### `from_yaml(cls, yaml_content: str) -> Policy`

**Decorators:** @classmethod

Create a Policy from YAML content.  This uses a simple YAML parser that handles the subset of YAML features we need, without requiring the PyYAML dependency.

**Parameters:**

- `yaml_content` (`str`) - YAML string containing policy definition

**Returns:**

`Policy` - New Policy instance

## PolicyCollection

A collection of Policy objects with filtering capabilities.

Provides methods to filter policies by various criteria
and look up policies by ID.

Attributes:
    policies: List of Policy objects in this collection

### Properties

#### `policies(self) -> list[Policy]`

Get the list of policies.

**Returns:**

`list[Policy]`

### Methods

#### `__init__(self, policies: list[Policy] | None) -> None`

Initialize collection with optional list of policies.

**Parameters:**

- `policies` (`list[Policy] | None`) - Initial list of policies (defaults to empty list)

**Returns:**

`None`

#### `add(self, policy: Policy) -> None`

Add a policy to the collection.

**Parameters:**

- `policy` (`Policy`) - Policy to add

**Returns:**

`None`

#### `filter_by_severity(self, severity: Severity) -> PolicyCollection`

Filter policies by severity.

**Parameters:**

- `severity` (`Severity`) - Severity level to filter by

**Returns:**

`PolicyCollection` - New PolicyCollection containing only matching policies

#### `filter_by_resource_type(self, resource_type: str) -> PolicyCollection`

Filter policies by resource type.

**Parameters:**

- `resource_type` (`str`) - Resource type to filter by

**Returns:**

`PolicyCollection` - New PolicyCollection containing only matching policies

#### `filter_by_framework(self, framework: str) -> PolicyCollection`

Filter policies by compliance framework.

**Parameters:**

- `framework` (`str`) - Framework identifier to filter by

**Returns:**

`PolicyCollection` - New PolicyCollection containing only matching policies

#### `filter_by_tag(self, tag: str) -> PolicyCollection`

Filter policies by tag.

**Parameters:**

- `tag` (`str`) - Tag to filter by

**Returns:**

`PolicyCollection` - New PolicyCollection containing only matching policies

#### `filter_enabled(self) -> PolicyCollection`

Filter to only enabled policies.

**Returns:**

`PolicyCollection` - New PolicyCollection containing only enabled policies

#### `get_by_id(self, policy_id: str) -> Policy | None`

Get a policy by its ID.

**Parameters:**

- `policy_id` (`str`) - Policy ID to find

**Returns:**

`Policy | None` - Policy if found, None otherwise

#### `to_list(self) -> list[dict[(str, Any)]]`

Convert collection to list of dictionaries.

**Returns:**

`list[dict[(str, Any)]]` - List of policy dictionaries

#### `to_json(self) -> str`

Convert collection to JSON string.

**Returns:**

`str` - JSON string representation

### Class Methods

#### `from_list(cls, data: list[dict[(str, Any)]]) -> PolicyCollection`

**Decorators:** @classmethod

Create collection from list of dictionaries.

**Parameters:**

- `data` (`list[dict[(str, Any)]]`) - List of policy dictionaries

**Returns:**

`PolicyCollection` - New PolicyCollection
