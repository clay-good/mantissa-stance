"""
Unit tests for vulnerability scanning module.

Tests cover:
- Vulnerability data classes
- Version range matching
- Severity calculations
- Database lookups (mocked)
- Scanner functionality
"""

from __future__ import annotations

from datetime import datetime
from unittest.mock import MagicMock, patch

import pytest

from stance.sbom.parser import Dependency, PackageEcosystem, DependencyScope


# =============================================================================
# Vulnerability Data Class Tests
# =============================================================================


class TestVulnerabilitySeverity:
    """Tests for VulnerabilitySeverity enum."""

    def test_severity_values(self):
        """Test that all severity values are defined."""
        from stance.sbom.vulnerability import VulnerabilitySeverity

        assert VulnerabilitySeverity.CRITICAL.value == "critical"
        assert VulnerabilitySeverity.HIGH.value == "high"
        assert VulnerabilitySeverity.MEDIUM.value == "medium"
        assert VulnerabilitySeverity.LOW.value == "low"
        assert VulnerabilitySeverity.NONE.value == "none"
        assert VulnerabilitySeverity.UNKNOWN.value == "unknown"


class TestVulnerabilitySource:
    """Tests for VulnerabilitySource enum."""

    def test_source_values(self):
        """Test that all source values are defined."""
        from stance.sbom.vulnerability import VulnerabilitySource

        assert VulnerabilitySource.NVD.value == "nvd"
        assert VulnerabilitySource.OSV.value == "osv"
        assert VulnerabilitySource.GHSA.value == "ghsa"
        assert VulnerabilitySource.LOCAL.value == "local"


class TestAffectedVersion:
    """Tests for AffectedVersion class."""

    def test_basic_version_affected(self):
        """Test basic version range checking."""
        from stance.sbom.vulnerability import AffectedVersion

        av = AffectedVersion(introduced="1.0.0", fixed="2.0.0")

        assert av.is_version_affected("1.5.0") is True
        assert av.is_version_affected("2.0.0") is False
        assert av.is_version_affected("0.9.0") is False
        assert av.is_version_affected("2.1.0") is False

    def test_version_only_introduced(self):
        """Test version range with only introduced."""
        from stance.sbom.vulnerability import AffectedVersion

        av = AffectedVersion(introduced="1.0.0")

        assert av.is_version_affected("1.5.0") is True
        assert av.is_version_affected("0.9.0") is False

    def test_version_with_last_affected(self):
        """Test version range with last_affected."""
        from stance.sbom.vulnerability import AffectedVersion

        av = AffectedVersion(introduced="1.0.0", last_affected="1.5.0")

        assert av.is_version_affected("1.3.0") is True
        assert av.is_version_affected("1.6.0") is False

    def test_to_dict(self):
        """Test conversion to dictionary."""
        from stance.sbom.vulnerability import AffectedVersion

        av = AffectedVersion(introduced="1.0.0", fixed="2.0.0")
        d = av.to_dict()

        assert d["introduced"] == "1.0.0"
        assert d["fixed"] == "2.0.0"
        assert d["version_type"] == "semver"


class TestVulnerability:
    """Tests for Vulnerability class."""

    def test_create_vulnerability(self):
        """Test creating a vulnerability."""
        from stance.sbom.vulnerability import (
            Vulnerability,
            VulnerabilitySeverity,
            VulnerabilitySource,
        )

        vuln = Vulnerability(
            id="CVE-2024-1234",
            summary="Test vulnerability",
            severity=VulnerabilitySeverity.HIGH,
            cvss_score=7.5,
            source=VulnerabilitySource.NVD,
            affected_ecosystem=PackageEcosystem.PYPI,
            affected_package="test-package",
        )

        assert vuln.id == "CVE-2024-1234"
        assert vuln.summary == "Test vulnerability"
        assert vuln.severity == VulnerabilitySeverity.HIGH
        assert vuln.cvss_score == 7.5

    def test_vulnerability_aliases(self):
        """Test vulnerability with aliases."""
        from stance.sbom.vulnerability import Vulnerability

        vuln = Vulnerability(
            id="GHSA-xxxx-xxxx-xxxx",
            aliases=["CVE-2024-1234", "PYSEC-2024-123"],
        )

        assert "CVE-2024-1234" in vuln.aliases
        assert "PYSEC-2024-123" in vuln.aliases

    def test_is_version_affected_no_constraints(self):
        """Test that all versions are affected when no constraints."""
        from stance.sbom.vulnerability import Vulnerability

        vuln = Vulnerability(id="CVE-2024-1234")

        assert vuln.is_version_affected("1.0.0") is True
        assert vuln.is_version_affected("99.0.0") is True

    def test_is_version_affected_with_ranges(self):
        """Test version affected with version ranges."""
        from stance.sbom.vulnerability import Vulnerability, AffectedVersion

        vuln = Vulnerability(
            id="CVE-2024-1234",
            affected_versions=[
                AffectedVersion(introduced="1.0.0", fixed="1.5.0"),
                AffectedVersion(introduced="2.0.0", fixed="2.3.0"),
            ],
        )

        assert vuln.is_version_affected("1.2.0") is True
        assert vuln.is_version_affected("2.1.0") is True
        assert vuln.is_version_affected("1.6.0") is False
        assert vuln.is_version_affected("3.0.0") is False

    def test_to_dict(self):
        """Test conversion to dictionary."""
        from stance.sbom.vulnerability import (
            Vulnerability,
            VulnerabilitySeverity,
            VulnerabilitySource,
        )

        vuln = Vulnerability(
            id="CVE-2024-1234",
            summary="Test",
            severity=VulnerabilitySeverity.MEDIUM,
            source=VulnerabilitySource.OSV,
            affected_ecosystem=PackageEcosystem.NPM,
            affected_package="test-pkg",
        )
        d = vuln.to_dict()

        assert d["id"] == "CVE-2024-1234"
        assert d["severity"] == "medium"
        assert d["source"] == "osv"


class TestVulnerabilityMatch:
    """Tests for VulnerabilityMatch class."""

    def test_create_match(self):
        """Test creating a vulnerability match."""
        from stance.sbom.vulnerability import (
            Vulnerability,
            VulnerabilityMatch,
            VulnerabilitySeverity,
        )

        dep = Dependency(
            name="test-pkg",
            version="1.0.0",
            ecosystem=PackageEcosystem.PYPI,
        )
        vuln = Vulnerability(
            id="CVE-2024-1234",
            severity=VulnerabilitySeverity.HIGH,
        )

        match = VulnerabilityMatch(dependency=dep, vulnerability=vuln)

        assert match.dependency.name == "test-pkg"
        assert match.vulnerability.id == "CVE-2024-1234"
        assert match.severity == VulnerabilitySeverity.HIGH

    def test_to_dict(self):
        """Test conversion to dictionary."""
        from stance.sbom.vulnerability import Vulnerability, VulnerabilityMatch

        dep = Dependency(
            name="test-pkg",
            version="1.0.0",
            ecosystem=PackageEcosystem.PYPI,
        )
        vuln = Vulnerability(id="CVE-2024-1234")

        match = VulnerabilityMatch(dependency=dep, vulnerability=vuln)
        d = match.to_dict()

        assert d["dependency"]["name"] == "test-pkg"
        assert d["vulnerability"]["id"] == "CVE-2024-1234"


# =============================================================================
# VulnerabilityScanResult Tests
# =============================================================================


class TestVulnerabilityScanResult:
    """Tests for VulnerabilityScanResult class."""

    def test_empty_result(self):
        """Test empty scan result."""
        from stance.sbom.vulnerability import VulnerabilityScanResult

        result = VulnerabilityScanResult(total_dependencies=10)

        assert result.total_dependencies == 10
        assert result.vulnerable_dependencies == 0
        assert result.total_vulnerabilities == 0
        assert result.has_vulnerabilities is False

    def test_highest_severity_none(self):
        """Test highest severity when no vulnerabilities."""
        from stance.sbom.vulnerability import (
            VulnerabilityScanResult,
            VulnerabilitySeverity,
        )

        result = VulnerabilityScanResult()

        assert result.highest_severity == VulnerabilitySeverity.NONE

    def test_highest_severity_critical(self):
        """Test highest severity when critical exists."""
        from stance.sbom.vulnerability import (
            VulnerabilityScanResult,
            VulnerabilitySeverity,
        )

        result = VulnerabilityScanResult(
            critical_count=1,
            high_count=5,
            medium_count=10,
        )

        assert result.highest_severity == VulnerabilitySeverity.CRITICAL

    def test_highest_severity_high(self):
        """Test highest severity when high is max."""
        from stance.sbom.vulnerability import (
            VulnerabilityScanResult,
            VulnerabilitySeverity,
        )

        result = VulnerabilityScanResult(
            high_count=5,
            medium_count=10,
        )

        assert result.highest_severity == VulnerabilitySeverity.HIGH

    def test_get_critical_matches(self):
        """Test getting critical severity matches."""
        from stance.sbom.vulnerability import (
            Vulnerability,
            VulnerabilityMatch,
            VulnerabilityScanResult,
            VulnerabilitySeverity,
        )

        dep = Dependency(name="test", version="1.0.0", ecosystem=PackageEcosystem.PYPI)
        critical_vuln = Vulnerability(id="CVE-1", severity=VulnerabilitySeverity.CRITICAL)
        high_vuln = Vulnerability(id="CVE-2", severity=VulnerabilitySeverity.HIGH)

        result = VulnerabilityScanResult(
            matches=[
                VulnerabilityMatch(dependency=dep, vulnerability=critical_vuln),
                VulnerabilityMatch(dependency=dep, vulnerability=high_vuln),
            ],
            critical_count=1,
            high_count=1,
        )

        critical_matches = result.get_critical_matches()
        assert len(critical_matches) == 1
        assert critical_matches[0].vulnerability.id == "CVE-1"

    def test_group_by_dependency(self):
        """Test grouping matches by dependency."""
        from stance.sbom.vulnerability import (
            Vulnerability,
            VulnerabilityMatch,
            VulnerabilityScanResult,
        )

        dep1 = Dependency(name="pkg1", version="1.0.0", ecosystem=PackageEcosystem.NPM)
        dep2 = Dependency(name="pkg2", version="2.0.0", ecosystem=PackageEcosystem.NPM)
        vuln1 = Vulnerability(id="CVE-1")
        vuln2 = Vulnerability(id="CVE-2")

        result = VulnerabilityScanResult(
            matches=[
                VulnerabilityMatch(dependency=dep1, vulnerability=vuln1),
                VulnerabilityMatch(dependency=dep1, vulnerability=vuln2),
                VulnerabilityMatch(dependency=dep2, vulnerability=vuln1),
            ],
        )

        grouped = result.group_by_dependency()
        assert "pkg1@1.0.0" in grouped
        assert "pkg2@2.0.0" in grouped
        assert len(grouped["pkg1@1.0.0"]) == 2

    def test_to_dict(self):
        """Test conversion to dictionary."""
        from stance.sbom.vulnerability import VulnerabilityScanResult

        result = VulnerabilityScanResult(
            total_dependencies=50,
            vulnerable_dependencies=5,
            total_vulnerabilities=10,
            critical_count=1,
            high_count=3,
            medium_count=4,
            low_count=2,
        )
        d = result.to_dict()

        assert d["summary"]["total_dependencies"] == 50
        assert d["severity_breakdown"]["critical"] == 1
        assert d["severity_breakdown"]["high"] == 3


# =============================================================================
# VulnerabilityDatabase Tests
# =============================================================================


class TestVulnerabilityDatabase:
    """Tests for VulnerabilityDatabase class."""

    def test_create_database(self):
        """Test creating a vulnerability database."""
        from stance.sbom.vulnerability import VulnerabilityDatabase

        db = VulnerabilityDatabase()

        assert db is not None
        assert db._offline_mode is False

    def test_create_offline_database(self):
        """Test creating an offline database."""
        from stance.sbom.vulnerability import VulnerabilityDatabase

        db = VulnerabilityDatabase(offline_mode=True)

        assert db._offline_mode is True

    def test_cvss_to_severity_critical(self):
        """Test CVSS to severity conversion for critical."""
        from stance.sbom.vulnerability import (
            VulnerabilityDatabase,
            VulnerabilitySeverity,
        )

        db = VulnerabilityDatabase()

        assert db._cvss_to_severity(9.5) == VulnerabilitySeverity.CRITICAL
        assert db._cvss_to_severity(10.0) == VulnerabilitySeverity.CRITICAL

    def test_cvss_to_severity_high(self):
        """Test CVSS to severity conversion for high."""
        from stance.sbom.vulnerability import (
            VulnerabilityDatabase,
            VulnerabilitySeverity,
        )

        db = VulnerabilityDatabase()

        assert db._cvss_to_severity(7.0) == VulnerabilitySeverity.HIGH
        assert db._cvss_to_severity(8.9) == VulnerabilitySeverity.HIGH

    def test_cvss_to_severity_medium(self):
        """Test CVSS to severity conversion for medium."""
        from stance.sbom.vulnerability import (
            VulnerabilityDatabase,
            VulnerabilitySeverity,
        )

        db = VulnerabilityDatabase()

        assert db._cvss_to_severity(4.0) == VulnerabilitySeverity.MEDIUM
        assert db._cvss_to_severity(6.9) == VulnerabilitySeverity.MEDIUM

    def test_cvss_to_severity_low(self):
        """Test CVSS to severity conversion for low."""
        from stance.sbom.vulnerability import (
            VulnerabilityDatabase,
            VulnerabilitySeverity,
        )

        db = VulnerabilityDatabase()

        assert db._cvss_to_severity(0.1) == VulnerabilitySeverity.LOW
        assert db._cvss_to_severity(3.9) == VulnerabilitySeverity.LOW

    def test_string_to_severity(self):
        """Test string to severity conversion."""
        from stance.sbom.vulnerability import (
            VulnerabilityDatabase,
            VulnerabilitySeverity,
        )

        db = VulnerabilityDatabase()

        assert db._string_to_severity("critical") == VulnerabilitySeverity.CRITICAL
        assert db._string_to_severity("HIGH") == VulnerabilitySeverity.HIGH
        assert db._string_to_severity("moderate") == VulnerabilitySeverity.MEDIUM
        assert db._string_to_severity("low") == VulnerabilitySeverity.LOW
        assert db._string_to_severity("unknown") == VulnerabilitySeverity.UNKNOWN

    def test_add_local_vulnerability(self):
        """Test adding a local vulnerability."""
        from stance.sbom.vulnerability import (
            VulnerabilityDatabase,
            Vulnerability,
            VulnerabilitySeverity,
        )

        db = VulnerabilityDatabase()
        vuln = Vulnerability(
            id="LOCAL-001",
            severity=VulnerabilitySeverity.HIGH,
            affected_ecosystem=PackageEcosystem.PYPI,
            affected_package="test-pkg",
        )

        db.add_local_vulnerability(vuln)

        results = db._query_local_cache("test-pkg", PackageEcosystem.PYPI)
        assert len(results) == 1
        assert results[0].id == "LOCAL-001"


# =============================================================================
# VulnerabilityScanner Tests
# =============================================================================


class TestVulnerabilityScanner:
    """Tests for VulnerabilityScanner class."""

    def test_create_scanner(self):
        """Test creating a vulnerability scanner."""
        from stance.sbom.vulnerability import VulnerabilityScanner

        scanner = VulnerabilityScanner()

        assert scanner is not None

    def test_scan_dependency_no_vulns(self):
        """Test scanning a dependency with no vulnerabilities."""
        from stance.sbom.vulnerability import (
            VulnerabilityScanner,
            VulnerabilityDatabase,
        )

        db = VulnerabilityDatabase(offline_mode=True)
        scanner = VulnerabilityScanner(database=db)

        dep = Dependency(
            name="safe-package",
            version="1.0.0",
            ecosystem=PackageEcosystem.PYPI,
        )

        matches = scanner.scan_dependency(dep)
        assert len(matches) == 0

    def test_scan_dependency_with_local_vuln(self):
        """Test scanning a dependency with local vulnerability."""
        from stance.sbom.vulnerability import (
            VulnerabilityScanner,
            VulnerabilityDatabase,
            Vulnerability,
            VulnerabilitySeverity,
            VulnerabilitySource,
        )

        db = VulnerabilityDatabase(offline_mode=True)
        vuln = Vulnerability(
            id="LOCAL-001",
            severity=VulnerabilitySeverity.HIGH,
            affected_ecosystem=PackageEcosystem.PYPI,
            affected_package="vulnerable-pkg",
        )
        db.add_local_vulnerability(vuln)

        scanner = VulnerabilityScanner(database=db, sources=[VulnerabilitySource.LOCAL])

        dep = Dependency(
            name="vulnerable-pkg",
            version="1.0.0",
            ecosystem=PackageEcosystem.PYPI,
        )

        matches = scanner.scan_dependency(dep)
        assert len(matches) == 1
        assert matches[0].vulnerability.id == "LOCAL-001"

    def test_scan_dependencies_empty(self):
        """Test scanning empty dependency list."""
        from stance.sbom.vulnerability import VulnerabilityScanner

        scanner = VulnerabilityScanner()

        result = scanner.scan_dependencies([])

        assert result.total_dependencies == 0
        assert result.total_vulnerabilities == 0

    def test_scan_dependencies_counts(self):
        """Test that scan result counts are correct."""
        from stance.sbom.vulnerability import (
            VulnerabilityScanner,
            VulnerabilityDatabase,
            Vulnerability,
            VulnerabilitySeverity,
            VulnerabilitySource,
        )

        db = VulnerabilityDatabase(offline_mode=True)

        # Add vulnerabilities
        for i, sev in enumerate([
            VulnerabilitySeverity.CRITICAL,
            VulnerabilitySeverity.HIGH,
            VulnerabilitySeverity.MEDIUM,
        ]):
            vuln = Vulnerability(
                id=f"LOCAL-{i}",
                severity=sev,
                affected_ecosystem=PackageEcosystem.NPM,
                affected_package=f"pkg-{i}",
            )
            db.add_local_vulnerability(vuln)

        scanner = VulnerabilityScanner(database=db, sources=[VulnerabilitySource.LOCAL])

        deps = [
            Dependency(name="pkg-0", version="1.0.0", ecosystem=PackageEcosystem.NPM),
            Dependency(name="pkg-1", version="1.0.0", ecosystem=PackageEcosystem.NPM),
            Dependency(name="pkg-2", version="1.0.0", ecosystem=PackageEcosystem.NPM),
            Dependency(name="safe-pkg", version="1.0.0", ecosystem=PackageEcosystem.NPM),
        ]

        result = scanner.scan_dependencies(deps)

        assert result.total_dependencies == 4
        assert result.vulnerable_dependencies == 3
        assert result.total_vulnerabilities == 3
        assert result.critical_count == 1
        assert result.high_count == 1
        assert result.medium_count == 1

    def test_get_summary(self):
        """Test generating human-readable summary."""
        from stance.sbom.vulnerability import (
            VulnerabilityScanner,
            VulnerabilityScanResult,
        )

        scanner = VulnerabilityScanner()
        result = VulnerabilityScanResult(
            total_dependencies=100,
            vulnerable_dependencies=5,
            total_vulnerabilities=10,
            critical_count=2,
            high_count=3,
            medium_count=5,
        )

        summary = scanner.get_summary(result)

        assert "Dependencies Scanned: 100" in summary
        assert "Vulnerable Dependencies: 5" in summary
        assert "Critical: 2" in summary


# =============================================================================
# Convenience Function Tests
# =============================================================================


class TestScanVulnerabilitiesFunction:
    """Tests for scan_vulnerabilities convenience function."""

    def test_invalid_path(self):
        """Test that invalid path raises error."""
        from stance.sbom.vulnerability import scan_vulnerabilities

        with pytest.raises(FileNotFoundError):
            scan_vulnerabilities("/nonexistent/path")


# =============================================================================
# API Endpoint Tests
# =============================================================================


class TestVulnerabilityAPIEndpoints:
    """Tests for vulnerability API endpoints."""

    @pytest.fixture
    def handler(self):
        """Create a mock request handler."""
        from stance.web.server import StanceRequestHandler
        from unittest.mock import MagicMock

        handler = MagicMock(spec=StanceRequestHandler)
        handler.storage = MagicMock()
        return handler

    def test_vuln_info_returns_module_info(self, handler):
        """Test that info endpoint returns module information."""
        from stance.web.server import StanceRequestHandler

        result = StanceRequestHandler._vuln_info(handler, {})

        assert result is not None
        assert result["module"] == "stance.sbom.vulnerability"
        assert "description" in result
        assert "capabilities" in result
        assert len(result["capabilities"]) > 0

    def test_vuln_info_has_components(self, handler):
        """Test that info includes components."""
        from stance.web.server import StanceRequestHandler

        result = StanceRequestHandler._vuln_info(handler, {})

        assert "components" in result
        assert "VulnerabilityDatabase" in result["components"]
        assert "VulnerabilityScanner" in result["components"]

    def test_vuln_sources_returns_list(self, handler):
        """Test that sources endpoint returns a list."""
        from stance.web.server import StanceRequestHandler

        result = StanceRequestHandler._vuln_sources(handler, {})

        assert result is not None
        assert "sources" in result
        assert len(result["sources"]) >= 2
        assert "total" in result

    def test_vuln_sources_includes_osv(self, handler):
        """Test that OSV source is included."""
        from stance.web.server import StanceRequestHandler

        result = StanceRequestHandler._vuln_sources(handler, {})

        source_ids = [s["id"] for s in result["sources"]]
        assert "osv" in source_ids

    def test_vuln_sources_includes_nvd(self, handler):
        """Test that NVD source is included."""
        from stance.web.server import StanceRequestHandler

        result = StanceRequestHandler._vuln_sources(handler, {})

        source_ids = [s["id"] for s in result["sources"]]
        assert "nvd" in source_ids

    def test_vuln_status_returns_status(self, handler):
        """Test that status endpoint returns status."""
        from stance.web.server import StanceRequestHandler

        result = StanceRequestHandler._vuln_status(handler, {})

        assert result is not None
        assert "status" in result

    def test_vuln_summary_returns_overview(self, handler):
        """Test that summary endpoint returns overview."""
        from stance.web.server import StanceRequestHandler

        result = StanceRequestHandler._vuln_summary(handler, {})

        assert result is not None
        assert "overview" in result
        assert "features" in result
        assert "severity_levels" in result

    def test_vuln_lookup_requires_package(self, handler):
        """Test that lookup endpoint requires package name."""
        from stance.web.server import StanceRequestHandler

        result = StanceRequestHandler._vuln_lookup(handler, {})

        assert "error" in result


# =============================================================================
# Integration Tests
# =============================================================================


class TestVulnerabilityModuleExports:
    """Tests for vulnerability module exports."""

    def test_vulnerability_exported(self):
        """Test that Vulnerability is exported."""
        from stance.sbom import Vulnerability

        assert Vulnerability is not None

    def test_vulnerability_database_exported(self):
        """Test that VulnerabilityDatabase is exported."""
        from stance.sbom import VulnerabilityDatabase

        assert VulnerabilityDatabase is not None

    def test_vulnerability_scanner_exported(self):
        """Test that VulnerabilityScanner is exported."""
        from stance.sbom import VulnerabilityScanner

        assert VulnerabilityScanner is not None

    def test_vulnerability_match_exported(self):
        """Test that VulnerabilityMatch is exported."""
        from stance.sbom import VulnerabilityMatch

        assert VulnerabilityMatch is not None

    def test_vulnerability_scan_result_exported(self):
        """Test that VulnerabilityScanResult is exported."""
        from stance.sbom import VulnerabilityScanResult

        assert VulnerabilityScanResult is not None

    def test_scan_vulnerabilities_exported(self):
        """Test that scan_vulnerabilities is exported."""
        from stance.sbom import scan_vulnerabilities

        assert scan_vulnerabilities is not None
