id: azure-sql-002
name: SQL Database uses customer-managed TDE key
description: |
  Ensure Azure SQL databases use customer-managed keys (CMK) for
  Transparent Data Encryption instead of service-managed keys.
  CMK provides full control over key lifecycle and access.

enabled: true
severity: medium

resource_type: azure_sql_database

check:
  type: expression
  expression: "resource.tde_protector_type == 'AzureKeyVault'"

compliance:
  - framework: cis-azure-foundations
    version: "2.0.0"
    control: "4.1.3"
  - framework: pci-dss
    version: "4.0"
    control: "3.6.1"
  - framework: nist-800-53
    version: "rev5"
    control: "SC-12"

remediation:
  guidance: |
    1. Create a key in Azure Key Vault:
       a. Create or select a Key Vault
       b. Create a new RSA 2048 key
       c. Enable soft delete and purge protection
    2. Grant SQL Server access to Key Vault:
       a. Navigate to the SQL Server
       b. Enable system-assigned managed identity
       c. Grant Key Vault key permissions
    3. Configure TDE with customer-managed key:
       a. Go to SQL Server > Transparent data encryption
       b. Select "Customer-managed key"
       c. Select the Key Vault and key
       d. Save changes
  automation_supported: false

tags:
  - sql
  - encryption
  - tde
  - byok
  - key-vault
  - azure

references:
  - https://docs.microsoft.com/en-us/azure/azure-sql/database/transparent-data-encryption-byok-overview
