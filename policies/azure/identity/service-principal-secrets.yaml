id: azure-identity-005
name: Service principal secrets rotation
description: |
  Ensure service principal secrets (client secrets) are rotated
  regularly and have appropriate expiration. Long-lived secrets
  increase the risk of credential compromise.

enabled: true
severity: medium

resource_type: azure_service_principal

check:
  type: expression
  expression: |
    resource.credential_count == 0 or
    resource.oldest_credential_age_days <= 90

compliance:
  - framework: cis-azure-foundations
    version: "2.0.0"
    control: "1.11"
  - framework: nist-800-53
    version: "rev5"
    control: "IA-5(1)"
  - framework: pci-dss
    version: "4.0"
    control: "8.3.9"

remediation:
  guidance: |
    1. Navigate to Azure Active Directory > App registrations
    2. Select the application with old secrets
    3. Go to "Certificates & secrets"
    4. Create a new client secret with appropriate expiration
    5. Update applications to use the new secret
    6. Delete old secrets after confirming new secret works
    7. Consider using certificates instead of secrets
    8. Consider using Managed Identity where possible
  automation_supported: false

tags:
  - identity
  - service-principal
  - secrets
  - rotation
  - azure

references:
  - https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal
  - https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview
