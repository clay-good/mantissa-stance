id: gcp-functions-005
name: Cloud Function uses Secret Manager for secrets
description: |
  Ensure Cloud Functions use Secret Manager for sensitive data instead
  of environment variables. Secret Manager provides encryption, access
  control, and audit logging for secrets.

enabled: true
severity: high

resource_type: gcp_cloud_function

check:
  type: expression
  expression: "resource.has_plain_env_secrets == false"

compliance:
  - framework: cis-gcp-foundations
    version: "1.3.0"
    control: "7.3"
  - framework: nist-800-53
    version: "rev5"
    control: "SC-12"
  - framework: pci-dss
    version: "4.0"
    control: "3.4"

remediation:
  guidance: |
    1. Store secrets in Secret Manager:
       - gcloud secrets create SECRET_NAME --data-file=SECRET_FILE
    2. Grant function service account access:
       - gcloud secrets add-iam-policy-binding SECRET_NAME \
         --member="serviceAccount:FUNCTION_SA@PROJECT.iam.gserviceaccount.com" \
         --role="roles/secretmanager.secretAccessor"
    3. Configure function to use secrets:
       - Using secret volumes, or
       - Using secret environment variables (Cloud Functions Gen2)
    4. Remove plain text secrets from environment variables
    5. Deploy the function
  automation_supported: false

tags:
  - functions
  - secrets
  - secret-manager
  - serverless
  - encryption

references:
  - https://cloud.google.com/functions/docs/configuring/secrets
