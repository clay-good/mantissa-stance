id: aws-ec2-006
name: Database ports not exposed to internet
description: |
  Ensure security groups do not allow unrestricted access to database
  ports from the internet. Exposing database ports like MySQL (3306),
  PostgreSQL (5432), MSSQL (1433), MongoDB (27017) to the internet
  creates significant security risks.

enabled: true
severity: critical

resource_type: aws_security_group

check:
  type: expression
  expression: |
    resource.allows_mysql_from_internet == false and
    resource.allows_postgres_from_internet == false and
    resource.allows_mssql_from_internet == false and
    resource.allows_mongodb_from_internet == false

compliance:
  - framework: cis-aws-foundations
    version: "1.5.0"
    control: "5.4"
  - framework: pci-dss
    version: "4.0"
    control: "1.3.1"
  - framework: nist-800-53
    version: "rev5"
    control: "SC-7"

remediation:
  guidance: |
    1. Open the Amazon EC2 console
    2. Navigate to Security Groups
    3. Select the security group
    4. Choose Inbound rules tab
    5. Remove or modify rules that allow database ports from 0.0.0.0/0:
       - Port 3306 (MySQL/MariaDB)
       - Port 5432 (PostgreSQL)
       - Port 1433 (MSSQL)
       - Port 27017 (MongoDB)
    6. Restrict source to specific VPC CIDR blocks or security groups
    7. Consider using VPC endpoints or private subnets for databases
  automation_supported: false

tags:
  - ec2
  - security-group
  - network
  - database
  - critical-security

references:
  - https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/security-group-rules.html
  - https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_Security.html
