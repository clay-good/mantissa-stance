# Secrets Detection Policy Pack
# Detects hardcoded secrets and sensitive data in code and configurations.
#
# Usage:
#   stance scan --policies ./secrets-detection.yaml --source ./my-code

metadata:
  name: secrets-detection
  version: "1.0.0"
  description: Detect hardcoded secrets and sensitive data
  author: Security Team
  tags:
    - secrets
    - security
    - code-scanning

settings:
  default_severity: high
  continue_on_error: true

  # File patterns to scan
  include_patterns:
    - "**/*.py"
    - "**/*.js"
    - "**/*.ts"
    - "**/*.java"
    - "**/*.go"
    - "**/*.rb"
    - "**/*.php"
    - "**/*.yaml"
    - "**/*.yml"
    - "**/*.json"
    - "**/*.xml"
    - "**/*.properties"
    - "**/*.env"
    - "**/*.conf"
    - "**/*.config"
    - "**/Dockerfile*"
    - "**/*.tf"
    - "**/*.tfvars"

  # Patterns to exclude
  exclude_patterns:
    - "**/node_modules/**"
    - "**/vendor/**"
    - "**/.git/**"
    - "**/dist/**"
    - "**/build/**"
    - "**/*.min.js"
    - "**/package-lock.json"
    - "**/yarn.lock"
    - "**/test/**"
    - "**/tests/**"
    - "**/__tests__/**"
    - "**/mock/**"
    - "**/mocks/**"
    - "**/fixtures/**"

rules:
  # AWS Credentials
  - id: SEC-AWS-001
    name: aws-access-key-id
    description: Detected AWS Access Key ID
    severity: critical
    type: regex
    pattern: '(?:A3T[A-Z0-9]|AKIA|AGPA|AIDA|AROA|AIPA|ANPA|ANVA|ASIA)[A-Z0-9]{16}'
    remediation: |
      Remove AWS access keys from code:
      1. Rotate the exposed access key immediately
      2. Use IAM roles instead of access keys
      3. Use environment variables or AWS Secrets Manager
      4. Add file to .gitignore if appropriate
    references:
      - https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html
    tags:
      - aws
      - credentials

  - id: SEC-AWS-002
    name: aws-secret-access-key
    description: Detected AWS Secret Access Key
    severity: critical
    type: regex
    pattern: '(?i)aws.{0,20}secret.{0,20}[''"][0-9a-zA-Z/+]{40}[''"]'
    remediation: |
      Remove AWS secret keys from code and rotate immediately.
    tags:
      - aws
      - credentials

  - id: SEC-AWS-003
    name: aws-account-id
    description: Detected AWS Account ID in sensitive context
    severity: medium
    type: regex
    pattern: '(?i)(aws_account_id|account.?id).{0,10}[''"]?[0-9]{12}[''"]?'
    remediation: |
      Consider using AWS STS to retrieve account ID dynamically.
    tags:
      - aws

  # GCP Credentials
  - id: SEC-GCP-001
    name: gcp-api-key
    description: Detected Google API Key
    severity: critical
    type: regex
    pattern: 'AIza[0-9A-Za-z\\-_]{35}'
    remediation: |
      Remove GCP API key from code:
      1. Regenerate the API key in Google Cloud Console
      2. Use service accounts instead of API keys
      3. Store in Secret Manager
    references:
      - https://cloud.google.com/docs/authentication/api-keys
    tags:
      - gcp
      - credentials

  - id: SEC-GCP-002
    name: gcp-service-account
    description: Detected GCP Service Account private key
    severity: critical
    type: regex
    pattern: '-----BEGIN (RSA )?PRIVATE KEY-----'
    file_patterns:
      - "**/*.json"
      - "**/*.pem"
      - "**/*.key"
    remediation: |
      Remove service account key from code:
      1. Rotate the service account key
      2. Use Workload Identity instead
      3. Store keys in Secret Manager
    tags:
      - gcp
      - credentials

  # Azure Credentials
  - id: SEC-AZURE-001
    name: azure-storage-key
    description: Detected Azure Storage Account Key
    severity: critical
    type: regex
    pattern: '(?i)DefaultEndpointsProtocol=https;AccountName=[^;]+;AccountKey=[A-Za-z0-9+/=]{88}'
    remediation: |
      Remove Azure storage keys from code:
      1. Rotate the storage key
      2. Use Managed Identities
      3. Use Azure Key Vault
    tags:
      - azure
      - credentials

  - id: SEC-AZURE-002
    name: azure-sas-token
    description: Detected Azure SAS Token
    severity: high
    type: regex
    pattern: '(?i)[?&]sv=\d{4}-\d{2}-\d{2}&.*sig=[A-Za-z0-9%]+'
    remediation: |
      SAS tokens should have limited scope and expiration.
    tags:
      - azure
      - credentials

  # Generic API Keys
  - id: SEC-API-001
    name: generic-api-key
    description: Detected generic API key pattern
    severity: high
    type: regex
    pattern: '(?i)(api[_-]?key|apikey|api[_-]?secret)[''"\s:=]+[''"][a-zA-Z0-9_\-]{20,}[''"]'
    remediation: |
      Remove API keys from code:
      1. Use environment variables
      2. Use a secrets manager
      3. Rotate the exposed key
    tags:
      - api
      - credentials

  - id: SEC-API-002
    name: bearer-token
    description: Detected Bearer token
    severity: high
    type: regex
    pattern: '(?i)bearer\s+[a-zA-Z0-9_\-\.]{20,}'
    remediation: |
      Remove bearer tokens from code.
    tags:
      - api
      - credentials

  # Database Credentials
  - id: SEC-DB-001
    name: database-connection-string
    description: Detected database connection string with password
    severity: critical
    type: regex
    pattern: '(?i)(mysql|postgres|postgresql|mongodb|redis|mssql|sqlserver):\/\/[^:]+:[^@]+@'
    remediation: |
      Remove database credentials from code:
      1. Use environment variables
      2. Use IAM database authentication
      3. Use secrets manager
    tags:
      - database
      - credentials

  - id: SEC-DB-002
    name: database-password
    description: Detected database password in configuration
    severity: critical
    type: regex
    pattern: '(?i)(db[_-]?password|database[_-]?password|mysql[_-]?password|pg[_-]?password)[''"\s:=]+[''"][^''"]{8,}[''"]'
    remediation: |
      Use environment variables or secrets manager for database passwords.
    tags:
      - database
      - credentials

  # Private Keys
  - id: SEC-KEY-001
    name: private-key-rsa
    description: Detected RSA private key
    severity: critical
    type: regex
    pattern: '-----BEGIN RSA PRIVATE KEY-----'
    remediation: |
      Remove private keys from code:
      1. Use certificate stores or key vaults
      2. Generate new keys if exposed
    tags:
      - keys
      - credentials

  - id: SEC-KEY-002
    name: private-key-openssh
    description: Detected OpenSSH private key
    severity: critical
    type: regex
    pattern: '-----BEGIN OPENSSH PRIVATE KEY-----'
    remediation: |
      Remove SSH private keys from code repository.
    tags:
      - keys
      - credentials

  - id: SEC-KEY-003
    name: private-key-ec
    description: Detected EC private key
    severity: critical
    type: regex
    pattern: '-----BEGIN EC PRIVATE KEY-----'
    remediation: |
      Remove EC private keys from code.
    tags:
      - keys
      - credentials

  - id: SEC-KEY-004
    name: pgp-private-key
    description: Detected PGP private key
    severity: critical
    type: regex
    pattern: '-----BEGIN PGP PRIVATE KEY BLOCK-----'
    remediation: |
      Remove PGP private keys from code.
    tags:
      - keys
      - credentials

  # OAuth and JWT
  - id: SEC-OAUTH-001
    name: oauth-client-secret
    description: Detected OAuth client secret
    severity: high
    type: regex
    pattern: '(?i)(client[_-]?secret|oauth[_-]?secret)[''"\s:=]+[''"][a-zA-Z0-9_\-]{20,}[''"]'
    remediation: |
      Remove OAuth secrets from code:
      1. Rotate the client secret
      2. Store in secrets manager
    tags:
      - oauth
      - credentials

  - id: SEC-JWT-001
    name: jwt-secret
    description: Detected JWT secret key
    severity: high
    type: regex
    pattern: '(?i)(jwt[_-]?secret|jwt[_-]?key|secret[_-]?key)[''"\s:=]+[''"][a-zA-Z0-9_\-]{20,}[''"]'
    remediation: |
      Remove JWT secrets from code.
    tags:
      - jwt
      - credentials

  # Third-party Services
  - id: SEC-SLACK-001
    name: slack-webhook
    description: Detected Slack webhook URL
    severity: high
    type: regex
    pattern: 'https://hooks\.slack\.com/services/T[A-Z0-9]+/B[A-Z0-9]+/[a-zA-Z0-9]+'
    remediation: |
      Remove Slack webhook URL from code:
      1. Regenerate webhook URL
      2. Store in environment variable
    tags:
      - slack
      - credentials

  - id: SEC-SLACK-002
    name: slack-token
    description: Detected Slack token
    severity: high
    type: regex
    pattern: 'xox[baprs]-[0-9]{10,13}-[0-9]{10,13}[a-zA-Z0-9-]*'
    remediation: |
      Remove Slack token and regenerate.
    tags:
      - slack
      - credentials

  - id: SEC-GITHUB-001
    name: github-token
    description: Detected GitHub token
    severity: critical
    type: regex
    pattern: '(?:ghp|gho|ghu|ghs|ghr)_[A-Za-z0-9_]{36,}'
    remediation: |
      Revoke GitHub token immediately and generate a new one.
    references:
      - https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token
    tags:
      - github
      - credentials

  - id: SEC-STRIPE-001
    name: stripe-api-key
    description: Detected Stripe API key
    severity: critical
    type: regex
    pattern: '(?:sk|pk)_(?:live|test)_[0-9a-zA-Z]{24,}'
    remediation: |
      Rotate Stripe API key immediately.
    tags:
      - stripe
      - credentials

  - id: SEC-TWILIO-001
    name: twilio-api-key
    description: Detected Twilio API key
    severity: high
    type: regex
    pattern: 'SK[0-9a-fA-F]{32}'
    remediation: |
      Rotate Twilio API key.
    tags:
      - twilio
      - credentials

  - id: SEC-SENDGRID-001
    name: sendgrid-api-key
    description: Detected SendGrid API key
    severity: high
    type: regex
    pattern: 'SG\.[a-zA-Z0-9_-]{22}\.[a-zA-Z0-9_-]{43}'
    remediation: |
      Rotate SendGrid API key.
    tags:
      - sendgrid
      - credentials

  # Passwords in code
  - id: SEC-PWD-001
    name: hardcoded-password
    description: Detected hardcoded password
    severity: high
    type: regex
    pattern: '(?i)(password|passwd|pwd)[''"\s:=]+[''"][^''"]{8,}[''"]'
    exclude_patterns:
      - "**/*test*"
      - "**/*spec*"
      - "**/*mock*"
    remediation: |
      Remove hardcoded passwords:
      1. Use environment variables
      2. Use a secrets manager
      3. Use configuration files outside repository
    tags:
      - password
      - credentials

  - id: SEC-PWD-002
    name: password-in-url
    description: Detected password in URL
    severity: critical
    type: regex
    pattern: '(?i)https?://[^:]+:[^@]+@[^\s]+'
    remediation: |
      Remove credentials from URLs.
    tags:
      - password
      - credentials

  # Environment Files
  - id: SEC-ENV-001
    name: env-file-secrets
    description: Detected secrets in .env file
    severity: high
    type: file_check
    file_patterns:
      - "**/.env"
      - "**/.env.*"
      - "**/*.env"
    condition: |
      !file.is_example && !file.is_template
    remediation: |
      Ensure .env files are in .gitignore:
      1. Add .env to .gitignore
      2. Use .env.example for templates (without real values)
    tags:
      - environment
      - credentials

# Suppressions for known false positives
suppressions:
  # Example suppression for test files
  - rule_id: SEC-PWD-001
    path_pattern: "**/test_*.py"
    reason: "Test files may contain mock passwords"

  - rule_id: SEC-PWD-001
    path_pattern: "**/*_test.go"
    reason: "Test files may contain mock passwords"

  # Suppress for documentation
  - rule_id: "*"
    path_pattern: "**/docs/**"
    reason: "Documentation may contain example patterns"

# Entropy analysis settings
entropy:
  enabled: true
  threshold: 4.5
  min_length: 20
  max_length: 200
